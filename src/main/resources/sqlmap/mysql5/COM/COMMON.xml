<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ARGOCOMMON"> 
    <typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap" />
    
	<select id="ARGOCOMMON.login" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* ID : ARGOCOMMON.login */
		SELECT CASE WHEN DATE_FORMAT(DATE_ADD(SYSDATE(), 
						INTERVAL - (IFNULL((SELECT CASE VAL_CUR WHEN '' THEN '500' WHEN '0' THEN '500' ELSE VAL_CUR END VAL_CUR 
										 FROM TB_WAS_CONFIG 
										WHERE SECTION = 'COMPANY' AND KEY_CODE = 'SITE_PWD_CHANGE'), '500')) MONTH
						), '%Y%m%d') > DATE_FORMAT(DATE_FORMAT(IFNULL(a.USER_PWD_UPT_DATE,DATE_FORMAT(SYSDATE(),'%Y%m%d')),'%Y%m%d'),'%Y%m%d') 
					THEN 'PWDCHG'
					WHEN (SELECT VAL_CUR FROM TB_WAS_CONFIG WHERE SECTION = 'COMPANY' AND KEY_CODE = 'INIT_PWD_CHANGE') = '1' 
						AND a.LOGIN_DATE IS NULL AND a.USER_PWD_UPT_DATE IS NULL
					THEN 'PWDCHG'
					WHEN ((SELECT USER_PWD FROM TB_MNG_USERINFO WHERE TENANT_ID ='bridgetec' AND USER_ID ='btadmin' ) = a.USER_PWD AND a.INS_ID = 'External')
					THEN 'PWDCHG'
					ELSE 'LOGINOK'
			   END AS RESULT_CD
			 , a.USER_ID AS AGENT_ID, a.TENANT_ID AS TENANT_ID, a.SALT, a.USER_PWD
			 , CASE WHEN a.PLAYER_KIND = '' THEN '0' WHEN IFNULL(a.PLAYER_KIND,'') = '' THEN '0' ELSE a.PLAYER_KIND END AS PLAYER_KIND
			 , CASE WHEN a.REAL_PLAY_KIND = '' THEN '0' WHEN IFNULL(a.REAL_PLAY_KIND,'') = '' THEN '0' ELSE a.REAL_PLAY_KIND END AS REAL_PLAY_KIND
			 , a.USER_ID, a.GRANT_ID, a.USER_NAME, DATE_FORMAT(SYSDATE(),'%H:%i:%s') AS LOGIN_TIME, DATE_FORMAT(SYSDATE(),'%Y%m%d') LOGIN_DATE
			 , a.CONVERT_FLAG, a.BACKUP_FLAG, a.GROUP_ID
			 , c.DEPTH
			 , b.GRANT_NAME, b.AUTH_RANK
			 , a.FORCED_LOGOUT, IFNULL(a.CONTROL_AUTH,'') CONTROL_AUTH, IFNULL(a.MAIN_PAGE,'') MAIN_PAGE
			 , IFNULL(a.LOGIN_DATE_CHECK_USE,'') LOGIN_DATE_CHECK_USE
			 , IFNULL(a.LOGIN_DATE_CHECK_FROM,'') LOGIN_DATE_CHECK_FROM
			 , IFNULL(a.LOGIN_DATE_CHECK_TO,'') LOGIN_DATE_CHECK_TO
			 , IFNULL(a.LOGIN_ERR_COUNT,0) LOGIN_ERR_COUNT
			 , IFNULL((SELECT VAL_CUR FROM TB_WAS_CONFIG WHERE SECTION = 'COMPANY' AND KEY_CODE = 'SITE_PWD_FAIL_COUNT'), 0) SITE_PWD_FAIL_COUNT
			 , IFNULL((SELECT VAL_CUR FROM TB_WAS_CONFIG WHERE SECTION = 'COMPANY' AND KEY_CODE = 'NOUSE_ACC_LOCK'), 0) AS NOUSE_ACC_LOCK
			 , IFNULL(DATE_FORMAT(a.LOGIN_DATE, '%Y%m%d'), '') AS LAST_LOGIN_DATE
		  FROM TB_MNG_USERINFO a
		  LEFT OUTER JOIN TB_MNG_AUTH b
			ON a.GRANT_ID = b.GRANT_ID
		   AND a.TENANT_ID = b.TENANT_ID
		  LEFT OUTER JOIN TB_MNG_GROUP c
			ON a.GROUP_ID = c.GROUP_ID
		   AND a.TENANT_ID= c.TENANT_ID
		 WHERE a.TENANT_ID = #tenantId#
		   AND a.USER_ID = #agentId#
		   AND a.RETIREE_FLAG != 0
		<isNotEmpty property="agentPw">
		   AND a.USER_PWD = #agentPw#
		</isNotEmpty>
	</select> 
	
	<select id="ARGOCOMMON.getIntroUserInfo" parameterClass="java.util.HashMap" resultClass="egovMap" >
		/* ID : ARGOCOMMON.getIntroUserInfo */
		SELECT AGENT_STATUS, COUNT(*) CNT
		  FROM (
			SELECT CASE WHEN IFNULL(NULLIF(AGENT_STATUS,''),'') IS NULL THEN '00'
						WHEN IFNULL(NULLIF(AGENT_STATUS,''),'') = '' THEN '00'
						ELSE AGENT_STATUS
				   END AS AGENT_STATUS
			  FROM TB_MNG_USERINFO
			 WHERE TENANT_ID = #tenantId#
			  AND RETIREE_FLAG = '1'
		  ) t
		 GROUP BY AGENT_STATUS
	</select>
	
	<select id="ARGOCOMMON.getIntroExtInfo" parameterClass="java.util.HashMap" resultClass="egovMap" >
		/* ID : ARGOCOMMON.getIntroExtInfo */
		SELECT DN_STATUS, COUNT(*) CNT
		  FROM (
			SELECT CASE IFNULL(NULLIF(DN_STATUS,''),'') WHEN '01' THEN DN_STATUS
														WHEN '10' THEN DN_STATUS
														ELSE '00'
				   END AS DN_STATUS
			  FROM TB_MNG_USERTELNO
			 WHERE TENANT_ID = #tenantId#
		  ) t
		 GROUP BY DN_STATUS
	</select>
	
	<select id="ARGOCOMMON.getIntroRecCntList" parameterClass="java.util.HashMap" resultClass="egovMap" >
		/* ID : ARGOCOMMON.getIntroRecCntList */
		SELECT CONCAT('당일(', td1.REC_DATE, ')') AS REC_DATE, IFNULL(NULLIF(tm1.SUM_CNT_M1,''),0) AS SUM_CNT_M1, IFNULL(NULLIF(tm1.TIME_AVG_M1,''),0) AS TIME_AVG_M1
		  FROM (
			SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d') AS REC_DATE
		  ) td1
		  LEFT OUTER JOIN (
			SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d') AS RDATE_M1, COUNT(1) AS SUM_CNT_M1, AVG(END_TIME) AS TIME_AVG_M1
			  FROM TB_REC_FILE
			 WHERE TENANT_ID = #tenantId#
			   AND REC_TIME <![CDATA[ >= ]]> DATE_FORMAT(SYSDATE(),'%Y%m%d')
			   AND REC_TIME <![CDATA[ <  ]]> CONCAT(DATE_FORMAT(SYSDATE(),'%Y%m%d'), '99')
			   AND SEARCH_VISIBLE = 1
			 GROUP BY DATE_FORMAT(DATE_FORMAT(SUBSTR(REC_TIME,1,8),'YYYYMMDD'),'d'), DATE_FORMAT(SYSDATE(),'%Y%m%d')
		  ) tm1
			ON td1.REC_DATE = tm1.RDATE_M1
		 UNION ALL
		SELECT CONCAT('전일(', td2.REC_DATE, ')') AS REC_DATE, IFNULL(tm2.SUM_CNT_M1,0) AS SUM_CNT_M1, IFNULL(tm2.TIME_AVG_M1,0) AS TIME_AVG_M1
		  FROM (
			SELECT DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -1 DAY),'%Y%m%d') AS REC_DATE
		  ) td2
		  LEFT OUTER JOIN (
			SELECT DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -1 DAY),'%Y%m%d') AS RDATE_D1, SUM(REC_COUNT) AS SUM_CNT_M1, AVG(END_TIME_AVG) AS TIME_AVG_M1
			  FROM TB_REC_FILE_DAY
			 WHERE TENANT_ID = #tenantId#
			   AND REC_TIME <![CDATA[ >= ]]> DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -1 DAY),'%Y%m%d')
			   AND REC_TIME <![CDATA[ <  ]]> CONCAT(DATE_FORMAT(SYSDATE()-1,'%Y%m%d'), '99')
			GROUP BY DATE_FORMAT(DATE_FORMAT(SUBSTR(REC_TIME,1,8),'%Y%m%d'),'d'), DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -1 DAY),'%Y%m%d')
		  ) tm2 
			ON td2.REC_DATE = tm2.RDATE_D1
		 UNION ALL
		SELECT CONCAT('전주(', td3.REC_DATE, ')') AS REC_DATE, IFNULL(tm3.SUM_CNT_M1,0) AS SUM_CNT_M1, IFNULL(tm3.TIME_AVG_M1,0) AS TIME_AVG_M1
		  FROM (
			SELECT DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -7 DAY),'%Y%m%d') AS REC_DATE
		  ) td3
		  LEFT OUTER JOIN (
			SELECT DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -7 DAY),'%Y%m%d') AS RDATE_D1, SUM(REC_COUNT) AS SUM_CNT_M1, AVG(END_TIME_AVG) AS TIME_AVG_M1
			  FROM TB_REC_FILE_DAY
			 WHERE TENANT_ID = #tenantId#
			   AND REC_TIME <![CDATA[ >= ]]> DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -7 DAY),'%Y%m%d')
			   AND REC_TIME <![CDATA[ <  ]]> CONCAT(DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -7 DAY),'%Y%m%d'), '99')
			 GROUP BY DATE_FORMAT(DATE_FORMAT(SUBSTR(REC_TIME,1,8),'%Y%m%d'),'d'), DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -7 DAY),'%Y%m%d')
		  ) tm3
			ON td3.REC_DATE = tm3.RDATE_D1
		UNION ALL
		SELECT CONCAT('전달(', td4.REC_DATE, ')') AS REC_DATE, IFNULL(SUM_CNT_M1,0) AS SUM_CNT_M1, IFNULL(TIME_AVG_M1,0) AS TIME_AVG_M1
		  FROM (
			SELECT DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL -1 MONTH),'%Y%m%d') AS REC_DATE
		  ) td4
		  LEFT OUTER JOIN (
			SELECT DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL -1 MONTH),'%Y%m%d') AS RDATE_D1, SUM(REC_COUNT) AS SUM_CNT_M1, AVG(END_TIME_AVG) AS TIME_AVG_M1
			  FROM TB_REC_FILE_DAY
			 WHERE TENANT_ID = #tenantId#
			   AND REC_TIME <![CDATA[ >= ]]> DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL -1 MONTH),'%Y%m%d')
			   AND REC_TIME <![CDATA[ <  ]]> CONCAT(DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL -1 MONTH),'%Y%m%d'), '99')
			 GROUP BY DATE_FORMAT(DATE_FORMAT(SUBSTR(REC_TIME,1,8),'%Y%m%d'),'d'), DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL -1 MONTH),'%Y%m%d')
		  ) tm4
			on td4.REC_DATE = tm4.RDATE_D1
	</select>
	
	<select id="ARGOCOMMON.getIntroRecentList" parameterClass="java.util.HashMap" resultClass="egovMap" >
		/* ID : ARGOCOMMON.getIntroRecentList */
		SELECT REC_TIME, SUM(REC_COUNT) AS REC_COUNT, AVG(REC_COUNT) AS REC_AVG
		  FROM ( 
			SELECT SUBSTR(REC_TIME,1,8) AS REC_TIME, USER_ID, SUM(REC_COUNT) AS REC_COUNT
			  FROM TB_REC_FILE_DAY 
			 WHERE REC_TIME > DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL -14 DAY),'%Y%m%d')
			   AND TENANT_ID = #tenantId#
			GROUP BY SUBSTR(REC_TIME,1,8), USER_ID
		  ) T_S
		 GROUP BY REC_TIME
		 ORDER BY REC_TIME
	</select>
	
	<select id="ARGOCOMMON.logoutCheck" parameterClass="java.util.HashMap" resultClass="String">
		/* ID : ARGOCOMMON.logoutCheck */
     	SELECT RTRIM(CAST(FORCED_LOGOUT AS CHAR(10))) AS FORCED_LOGOUT
    	  FROM TB_MNG_USERINFO
    	 WHERE TENANT_ID = #logoutTenantId#
    	   AND USER_ID = #logoutAgentId#
   </select>
   
   <select id="ARGOCOMMON.grantForm" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* ID :ARGOCOMMON.grantForm */
     	SELECT a.AUTH_KIND
     	  FROM TB_MNG_MENUAUTH a, TB_MNG_MENU b
		 WHERE a.tenant_id = '$TID$'
		   AND a.grant_id = '$GID$'
		   AND a.DEPTH1_ID = b.DEPTH1_ID
		   AND a.DEPTH2_ID = b.DEPTH2_ID
		   AND a.DEPTH3_ID = b.DEPTH3_ID
		   AND b.SRC_DO = '$URL$'
   </select>

</sqlMap>
