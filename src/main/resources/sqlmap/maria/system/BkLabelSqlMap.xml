<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
 "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bkLabel">
	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap" />
	
	<select id="bkLabel.getBkLabelCount" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* ID : bkLabel.getBkLabelCount */
		select count(*) as cnt
			FROM tb_sys_bklabel
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND"  property="findText">
				<isEqual property="findKey" compareValue="bk_label_id">		bk_label_id  	</isEqual>
				<isEqual property="findKey" compareValue="bk_device">		bk_device 		</isEqual>
				<isEqual property="findKey" compareValue="last_worker">		last_worker  	</isEqual>
				Like CONCAT('%', #findText#, '%')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="findFromCondition">
				<![CDATA[	from_condition >= #findFromCondition#	]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="findEndCondition">
				<![CDATA[	end_condition <= #findEndCondition#		]]>
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="bkLabel.getBkLabelList" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* ID : bkLabel.getBkLabelList */
		select	
				bk_label_id, bk_device, media_kind
				, DATE_FORMAT(STR_TO_DATE(from_condition, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s') as from_condition
				, DATE_FORMAT(STR_TO_DATE(end_condition, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s') as end_condition
				, store_place, CAST(bk_file_cnt AS CHAR(10)) as bk_file_cnt
				, CAST(used_space AS CHAR(10)) as used_space, CAST(usable_space AS CHAR(10)) as usable_space
				, RTRIM(CAST(store_year AS CHAR(10))) as store_year
				, last_worker, DATE_FORMAT(last_bk_time, '%Y-%m-%d %H:%i:%s') as last_bk_time, bk_run_flag, use_rate
			from(
				select * from (
					select
							Row_Number() over (order by last_bk_time ) RowNum2, TB_IN.* 
						from (
							select 
									Row_Number() over (order by last_bk_time desc) RowNum1
									, bk_label_id, bk_device, media_kind, from_condition, end_condition
									, store_place, IFNULL(bk_file_cnt,0) bk_file_cnt, IFNULL(used_space,0) used_space
									, IFNULL(usable_space,0) usable_space, IFNULL(store_year,0) store_year
									, last_worker, last_bk_time, case bk_run_flag when '1' then '진행' when '2' then '완료' else '' end as bk_run_flag
									, round((IFNULL(used_space,0)*100) / (IFNULL(used_space,0)+IFNULL(usable_space,0))) as use_rate
								FROM tb_sys_bklabel
							<dynamic prepend="WHERE">
								<isNotEmpty prepend="AND"  property="findText">
									<isEqual property="findKey" compareValue="bk_label_id">		bk_label_id  	</isEqual>
									<isEqual property="findKey" compareValue="bk_device">  		bk_device 		</isEqual>
									<isEqual property="findKey" compareValue="last_worker">  	last_worker  	</isEqual>
									Like CONCAT('%', #findText#, '%')
								</isNotEmpty>
								<isNotEmpty prepend="AND" property="findFromCondition">
									<![CDATA[	from_condition >= #findFromCondition#	]]>
								</isNotEmpty>
								<isNotEmpty prepend="AND" property="findEndCondition">
									<![CDATA[	end_condition <= #findEndCondition#		]]>
								</isNotEmpty>
							</dynamic>
						) TB_IN
				<!-- WHERE <![CDATA[ RowNum1 <= #iEPageNo# ]]> -->
					) TB_OUT 
			<!-- WHERE <![CDATA[ RowNum2 <= #iSPageNo# ]]> -->
			) tbl2
		order by last_bk_time desc
	</select>

	<update id="bkLabel.setBkLabelUpdate" parameterClass="java.util.HashMap">
		/* ID : bkLabel.setBkLabelUpdate */
		update tb_sys_bklabel
		   set last_worker = NULLIF(#lastWorker#, '')
			 , store_place = NULLIF(#storePlace#, '')
			 , store_year  = NULLIF(#storeYear#, '')
		 where bk_label_id = #bkLabelId#
	</update>
							
	<delete id="bkLabel.setBkLabelDelete" parameterClass="java.util.HashMap" >
		/* ID : bkLabel.setBkLabelDelete */
		delete from tb_sys_bklabel
		where bk_label_id = #bkLabelId#
	</delete>

</sqlMap>