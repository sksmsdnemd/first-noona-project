<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Group"> 
    <typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap" />
   
    <!-- <select id="Group.getParentID" parameterClass="java.util.HashMap" resultClass="egovMap">
		select parent_id FROM tb_mng_group
		where tenant_id = #tenantId#
			and group_id=#groupId#
	</select> -->
	
	<select id="Group.getMaxGroupId" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* ID : Group.getMaxGroupId */
		SELECT IFNULL(MAX(GROUP_ID),0) + 1 AS GROUP_ID
		  FROM TB_MNG_GROUP
		 WHERE TENANT_ID = #tenantId#
	</select>
	
	<!-- <select id="Group.getSubDepth" parameterClass="java.util.HashMap" resultClass="egovMap">
		select chr(ascii(depth2)+1) as depth 
			from (
				select top 1  right(depth,1) as depth2
					from tb_mng_group
					where tenant_id = #tenantId#
						and top_parent_id = #topParentId# 
						and depth like #depth# +'%' 
						and len(depth) = len(''+#depth#+'')+1
					order by depth desc)tb
	</select> -->
   
	<select id="Group.getGroupList" parameterClass="java.util.HashMap" resultClass="egovMap" >
   		/* ID : Group.getGroupList */
		WITH RECURSIVE RE_CATE AS (
			SELECT 1 LEVEL
				 , ROW_NUMBER() OVER() AS TOP_ORDER
				 , a.*
				 , a.GROUP_ID AS ID_PATH
			  FROM TB_MNG_GROUP a
			 WHERE a.TENANT_ID = #findTenantId#
			   AND a.PARENT_ID = '0'
			 UNION ALL
			 SELECT c.LEVEL + 1
				 , c.TOP_ORDER AS TOP_ORDER
				 , b.*
				 , CONCAT(c.ID_PATH, '>', b.GROUP_ID)
			  FROM TB_MNG_GROUP b
			 INNER JOIN RE_CATE c
				ON b.TENANT_ID = #findTenantId#
			   AND c.GROUP_ID = b.PARENT_ID
		)
		SELECT GROUP_ID
			 , PARENT_ID
			 , GROUP_NAME
			 , TOP_PARENT_ID
			 , DEPTH
			 , VALUE_TITLE_ID
			 , GROUP_MNG_ID
			 , INS_ID
			 , DATE_FORMAT(INS_DATE, '%Y-%m-%d %H:%i:%s') AS INS_DATE
			 , UPT_ID
			 , DATE_FORMAT(UPT_DATE, '%Y-%m-%d %H:%i:%s') AS UPT_DATE
			 , GROUP_DESC
			 , GROUP_NAME AS PARENT_NAME
			 , LEVEL AS GROUP_LEVEL
		FROM RE_CATE
		ORDER BY TOP_ORDER, ID_PATH
	</select>
	
	<!-- <select id="Group.getGroupList2" parameterClass="java.util.HashMap" resultClass="egovMap" >
		select tenant_id as code , tenant_name as code_nm , exception_find
		from tb_mng_company
		where com_status = 0
		order by tenant_name
	</select> -->
	
	<insert id="Group.setGroupInsert" parameterClass="java.util.HashMap">
		/* ID : Group.setGroupInsert */
		INSERT INTO TB_MNG_GROUP (
			TENANT_ID, GROUP_ID, TOP_PARENT_ID, PARENT_ID, DEPTH, GROUP_NAME, VALUE_TITLE_ID, GROUP_MNG_ID, GROUP_DESC, INS_ID, INS_DATE
		) VALUES (
			NULLIF(#tenantId#, ''), NULLIF(#groupId#, ''), NULLIF(#topParentId#, ''), NULLIF(#parentId#, '') , ''
			, NULLIF(#groupName#, ''), NULLIF(#valueTitleId#, ''), NULLIF(#groupMngId#, ''), NULLIF(#groupDesc#, ''), NULLIF(#insId#, ''), SYSDATE()
		)
	</insert>

   	<update id="Group.setGroupChangeUpdate" parameterClass="java.util.HashMap">
		/* ID : Group.setGroupChangeUpdate */   	
		UPDATE TB_MNG_GROUP
		   SET DEPTH = NULLIF(#destDepth#, '')
			 , UPT_ID = NULLIF(#adminId#, '')
			 , UPT_DATE = SYSDATE()
		 WHERE TENANT_ID = #tenantId#
		   AND GROUP_ID = #srcGroupId#
	</update>
	
	<update id="Group.setGroupChangeUpdate2" parameterClass="java.util.HashMap">
		/* ID : Group.setGroupChangeUpdate2 */
		UPDATE TB_MNG_GROUP
		   SET DEPTH = NULLIF(#srcDepth#, '')
			 , UPT_ID = NULLIF(#adminId#, '')
			 , UPT_DATE = SYSDATE()
		 WHERE TENANT_ID = #tenantId#
		   AND GROUP_ID = #destGroupId#
	</update>
   
   	<update id="Group.setGroupUpdate" parameterClass="java.util.HashMap">
		/* ID : Group.setGroupUpdate */   	
		UPDATE TB_MNG_GROUP
		   SET GROUP_NAME = NULLIF(#groupName#, '')
			 , VALUE_TITLE_ID = NULLIF(#valueTitleId#, '')
			 , GROUP_MNG_ID = NULLIF(#groupMngId#, '')
			 , GROUP_DESC = NULLIF(#groupDesc#, '')
			 , UPT_ID = NULLIF(#uptId#, '')
			 , UPT_DATE = SYSDATE()
		 WHERE TENANT_ID = #tenantId#
		   AND GROUP_ID = #groupId#
	</update>
	
	<delete id="Group.setGroupDelete" parameterClass="java.util.HashMap" >
		/* ID : Group.setGroupDelete */   	
		DELETE FROM TB_MNG_GROUP
		 WHERE TENANT_ID  = #tenantId#
		   AND GROUP_ID = #groupId#
	</delete>
	
    <select id="Group.getGroupIdCnt" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* ID : Group.getGroupIdCnt */
		SELECT COUNT(GROUP_ID) AS CNT
		  FROM TB_MNG_GROUP
		 WHERE TENANT_ID = #tenantId#
		   AND UPPER(GROUP_ID) = UPPER(#findGroupId#)
	</select>

    <update id="Group.setParentIdUpdate" parameterClass="java.util.HashMap">
    	/* ID : Group.setParentIdUpdate */
		UPDATE TB_MNG_GROUP
		   SET PARENT_ID = #parentId#
		 WHERE GROUP_ID = #groupId#
		   AND TENANT_ID = #tenantId#
	</update>

    <delete id="Group.deleteGroupList" parameterClass="java.util.HashMap">
    	/* ID : Group.deleteGroupList */
		DELETE FROM TB_MNG_GROUP
		 WHERE GROUP_ID = #findGroupId#
		   AND TENANT_ID = #findTenantId#
	</delete>
   
</sqlMap>
